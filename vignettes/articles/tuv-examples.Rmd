---
title: "R and the Quick TUV calculator"
subtitle: "Package 'photobiologyInOut' `r packageVersion('photobiologyInOut')` "
author: "Pedro J. Aphalo"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: yes
---

Package 'photobiologyInOut' since 2018, versions (>= 0.4.15), has supported the
import of the output files from interactively run spectral simulations done in
the Quick TUV calculator. In versions (>= 0.4.29) it is also possible to call
the Quick TUV calculator server directly from within R, to get the spectral data
returned in a `source_spct` object ready to be used with functions from the
R for Photobiology suite, or used as data frames with other R code.

The implementation of the interaction with the server is inspired on that used in package 'foqat'. This is actually very simple: construct an URL identical to that generated by the Quick TUV calculator web interface and use it to download the computed data into a file. This file is already in a format supported by an existing function in package 'photobiologyInOut'.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(photobiologyInOut)
library(ggspectra)
```

Using defaults for all arguments, the returned page is saved into a temporary file, the data read in and the file deleted.

```{r}
sun_greenwich_now.spct <- qtuv_s.e.irrad()
colnames(sun_greenwich_now.spct)
summary(sun_greenwich_now.spct)
cat(comment(sun_greenwich_now.spct))
what_measured(sun_greenwich_now.spct)
when_measured(sun_greenwich_now.spct)
how_measured(sun_greenwich_now.spct)
where_measured(sun_greenwich_now.spct)
attributes(sun_greenwich_now.spct)
```

```{r}
autoplot(sun_greenwich_now.spct)
```

To save the raw output from TUV into a persistent file, we have to provide a file name. We also extend the wavelength range, and provide the coordinates of a different location.

```{r}
my.geocode <- data.frame(lon = 24.96474, lat = 60.20911)

sun_viikki_now.spct <- 
  qtuv_s.e.irrad(w.length = 290:800,
                 geocode = my.geocode,
                 file = "qtuv-viikki-test.txt")
file.exists("qtuv-viikki-test.txt")
autoplot(sun_viikki_now.spct)
```

