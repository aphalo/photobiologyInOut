---
title: "R and the Quick TUV calculator"
subtitle: "Package 'photobiologyInOut' `r packageVersion('photobiologyInOut')` "
author: "Pedro J. Aphalo"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: yes
vignette: >
  %\VignetteIndexEntry{R and the Quick TUV calculator}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Package 'photobiologyInOut' since 2018, versions (>= 0.4.15), has supported the
import of the output files from interactively run spectral simulations done in
the Quick TUV calculator. In versions (>= 0.4.29) it is also possible to call
the Quick TUV calculator server directly from within R, to get the spectral data
returned in a `source_spct` object ready to be used with functions from the
R for Photobiology suite, or used as data frames with other R code.

The implementation of the interaction with the server is inspired on that used in package 'foqat'. This is actually very simple: construct an URL identical to that generated by the Quick TUV calculator web interface and use it to download the computed data into a file. This file is already in a format supported by an existing function in package 'photobiologyInOut'.

```{r, include = FALSE}
library(knitr)
opts_chunk$set(fig.align='center', fig.show='hold',
               fig.width=7, fig.height=6, size="footnotesize")
```

```{r setup}
library(photobiologyInOut)
library(ggspectra)
library(lubridate)

theme_set(theme_bw() + theme(legend.position = "top"))
```

## Simuation of a single spectrum

Using defaults for all arguments, the returned page is saved into a temporary file, the data read in and the file deleted.

```{r}
sun_greenwich.spct <- 
  qtuv_s.e.irrad(time = ymd_hm("2024-06-23 12:00", tz = "UTC"))
colnames(sun_greenwich.spct)
```

```{r}
summary(sun_greenwich.spct)
```

```{r}
cat(comment(sun_greenwich.spct))
```

```{r}
what_measured(sun_greenwich.spct)
```

```{r}
when_measured(sun_greenwich.spct)
```

```{r}
how_measured(sun_greenwich.spct)
```

```{r}
where_measured(sun_greenwich.spct)
```

```{r}
attr(sun_greenwich.spct, "qtuv.url")
```

```{r}
autoplot(sun_greenwich.spct)
```

To save the raw output from TUV into a persistent file, we have to provide a file name. We also extend the wavelength range, and provide the coordinates of a different location.

```{r}
my.geocode <- data.frame(lon = 24.96474, lat = 60.20911)
```


```{r}
sun_viikki.spct <- 
  qtuv_s.e.irrad(time = ymd_hm("2024-06-23 12:20", tz = "EET"),
                 w.length = 290:800,
                 geocode = my.geocode,
                 file = "qtuv-viikki-test.txt")

summary(sun_viikki.spct)
```

The file was not deleted as a file name was supplied.

```{r}
file.exists("qtuv-viikki-test.txt")
```

The spectrum was also imported into R as a `source_spct` object for which
an autoplot method is defined in package 'ggspectra'.

```{r}
autoplot(sun_viikki.spct)
```

```{r}
autoplot(sun_viikki.spct, unit.out = "photon")
```

## Simualtion of a collection of spectra

To not to abuse the UCAR server, the examples in this section create collections of very few spectra. The functions do not impose any strict limit but keep in mind that the recommended maximum is 100 spectra per user and day.

```{r}
sun_viikki_ozone.mspct <- 
  qtuv_m_s.e.irrad(
    time = ymd_hm("2024-06-23 12:20", tz = "EET"),
    ozone.du = c(200, 250, 300, 350),
    w.length = 290:450,
    geocode = my.geocode
  )

summary(sun_viikki_ozone.mspct)
autoplot(sun_viikki_ozone.mspct, 
         range = c(NA, 340), 
         annotations = c("-", "peaks"))
```

```{r}
sun_viikki_elevation.mspct <- 
  qtuv_m_s.e.irrad(
    time = ymd_hm("2024-06-23 12:20", tz = "EET"),
    sun.elevation = c(60, 40, 20),
    w.length = 290:450,
    geocode = my.geocode
  )

summary(sun_viikki_elevation.mspct)
autoplot(sun_viikki_elevation.mspct)
```

```{r, fig.height=8}
sun_viikki_time.mspct <- 
  qtuv_m_s.e.irrad(
    time = ymd_hm("2024-06-23 12:20", tz = "EET") +
      hours(c(0, 3, 6)),
    w.length = 290:750,
    geocode = my.geocode
  )

summary(sun_viikki_time.mspct)
autoplot(sun_viikki_time.mspct, facets = 1)
```

```{r}
my.geocodes <- data.frame(lat = c(30, 50, 70),
                          lon = rep(25, 3))
my.geocodes[["address"]] <- 
  paste("lat", my.geocodes[["lat"]], sep = ".")
```

```{r, fig.height=8}
sun_latitudes.mspct <- 
  qtuv_m_s.e.irrad(
    time = ymd_hm("2024-06-23 12:20", tz = "EET"),
    w.length = 290:750,
    geocode = my.geocodes
  )

summary(sun_latitudes.mspct)
autoplot(sun_latitudes.mspct, facets = 1)
```

```{r}
my.clouds <- qtuv_clouds(c("clear.sky", "cirrus"))
```

```{r, fig.height=8}
sun_viikki_clouds.mspct <- 
  qtuv_m_s.e.irrad(
    time = ymd_hm("2024-06-23 12:20", tz = "EET"),
    w.length = 290:750,
    geocode = my.geocode,
    clouds = my.clouds
  )

summary(sun_viikki_clouds.mspct)
autoplot(sun_viikki_clouds.mspct, facets = 1)
```

For three times, as above, but keeping the downloaded files, by passing a filename "root".

```{r}
sun_viikki_time.mspct <- 
  qtuv_m_s.e.irrad(
    time = ymd_hm("2024-06-23 12:20", tz = "EET") +
      hours(c(0, 3, 6)),
    w.length = 290:750,
    geocode = my.geocode,
    file = "qtuv-viikki"
  )

```

